{"ast":null,"code":"import { useState, useEffect, useReducer, useContext } from \"react\";\nimport toastError from \"../../errors/toastError\";\nimport api from \"../../services/api\";\n// import { SocketContext } from \"../../context/Socket/SocketContext\";\nimport { AuthContext } from \"../../context/Auth/AuthContext\";\nimport { isNill } from \"lodash\";\nconst reducer = (state, action) => {\n  if (action.type === \"LOAD_WHATSAPPS\") {\n    const whatsApps = action.payload;\n    return [...whatsApps];\n  }\n  if (action.type === \"UPDATE_WHATSAPPS\") {\n    const whatsApp = action.payload;\n    const whatsAppIndex = state.findIndex(s => s.id === whatsApp.id);\n    if (whatsAppIndex !== -1) {\n      state[whatsAppIndex] = whatsApp;\n      return [...state];\n    } else {\n      return [whatsApp, ...state];\n    }\n  }\n  if (action.type === \"UPDATE_SESSION\") {\n    const whatsApp = action.payload;\n    const whatsAppIndex = state.findIndex(s => s.id === whatsApp.id);\n    if (whatsAppIndex !== -1) {\n      state[whatsAppIndex].status = whatsApp.status;\n      state[whatsAppIndex].updatedAt = whatsApp.updatedAt;\n      state[whatsAppIndex].qrcode = whatsApp.qrcode;\n      state[whatsAppIndex].retries = whatsApp.retries;\n      return [...state];\n    } else {\n      return [...state];\n    }\n  }\n  if (action.type === \"DELETE_WHATSAPPS\") {\n    const whatsAppId = action.payload;\n    const whatsAppIndex = state.findIndex(s => s.id === whatsAppId);\n    if (whatsAppIndex !== -1) {\n      state.splice(whatsAppIndex, 1);\n    }\n    return [...state];\n  }\n  if (action.type === \"RESET\") {\n    return [];\n  }\n};\nconst useWhatsApps = () => {\n  const [whatsApps, dispatch] = useReducer(reducer, []);\n  const [loading, setLoading] = useState(true);\n  //   const socketManager = useContext(SocketContext);\n  const {\n    user,\n    socket\n  } = useContext(AuthContext);\n  useEffect(() => {\n    setLoading(true);\n    const fetchSession = async () => {\n      try {\n        const {\n          data\n        } = await api.get(\"/whatsapp/?session=0\");\n        dispatch({\n          type: \"LOAD_WHATSAPPS\",\n          payload: data\n        });\n        setLoading(false);\n      } catch (_) {\n        setLoading(false);\n        // toastError(err);\n      }\n    };\n    fetchSession();\n  }, []);\n  useEffect(() => {\n    if (user.companyId) {\n      const companyId = user.companyId;\n      //    const socket = socketManager.GetSocket();\n\n      const onCompanyWhatsapp = data => {\n        if (data.action === \"update\") {\n          dispatch({\n            type: \"UPDATE_WHATSAPPS\",\n            payload: data.whatsapp\n          });\n        }\n        if (data.action === \"delete\") {\n          dispatch({\n            type: \"DELETE_WHATSAPPS\",\n            payload: data.whatsappId\n          });\n        }\n      };\n      const onCompanyWhatsappSession = data => {\n        if (data.action === \"update\") {\n          dispatch({\n            type: \"UPDATE_SESSION\",\n            payload: data.session\n          });\n        }\n      };\n      socket.on(`company-${companyId}-whatsapp`, onCompanyWhatsapp);\n      socket.on(`company-${companyId}-whatsappSession`, onCompanyWhatsappSession);\n      return () => {\n        socket.off(`company-${companyId}-whatsapp`, onCompanyWhatsapp);\n        socket.off(`company-${companyId}-whatsappSession`, onCompanyWhatsappSession);\n      };\n    }\n  }, [socket]);\n  return {\n    whatsApps,\n    loading\n  };\n};\nexport default useWhatsApps;","map":{"version":3,"names":["useState","useEffect","useReducer","useContext","toastError","api","AuthContext","isNill","reducer","state","action","type","whatsApps","payload","whatsApp","whatsAppIndex","findIndex","s","id","status","updatedAt","qrcode","retries","whatsAppId","splice","useWhatsApps","dispatch","loading","setLoading","user","socket","fetchSession","data","get","_","companyId","onCompanyWhatsapp","whatsapp","whatsappId","onCompanyWhatsappSession","session","on","off"],"sources":["/workspaces/simao/whaticket/frontend/src/hooks/useWhatsApps/index.js"],"sourcesContent":["import { useState, useEffect, useReducer, useContext } from \"react\";\nimport toastError from \"../../errors/toastError\";\n\nimport api from \"../../services/api\";\n// import { SocketContext } from \"../../context/Socket/SocketContext\";\nimport { AuthContext } from \"../../context/Auth/AuthContext\";\nimport { isNill } from \"lodash\";\n\nconst reducer = (state, action) => {\n  if (action.type === \"LOAD_WHATSAPPS\") {\n    const whatsApps = action.payload;\n\n    return [...whatsApps];\n  }\n\n  if (action.type === \"UPDATE_WHATSAPPS\") {\n    const whatsApp = action.payload;\n    const whatsAppIndex = state.findIndex((s) => s.id === whatsApp.id);\n\n    if (whatsAppIndex !== -1) {\n      state[whatsAppIndex] = whatsApp;\n      return [...state];\n    } else {\n      return [whatsApp, ...state];\n    }\n  }\n\n  if (action.type === \"UPDATE_SESSION\") {\n    const whatsApp = action.payload;\n    const whatsAppIndex = state.findIndex((s) => s.id === whatsApp.id);\n\n    if (whatsAppIndex !== -1) {\n      state[whatsAppIndex].status = whatsApp.status;\n      state[whatsAppIndex].updatedAt = whatsApp.updatedAt;\n      state[whatsAppIndex].qrcode = whatsApp.qrcode;\n      state[whatsAppIndex].retries = whatsApp.retries;\n      return [...state];\n    } else {\n      return [...state];\n    }\n  }\n\n  if (action.type === \"DELETE_WHATSAPPS\") {\n    const whatsAppId = action.payload;\n\n    const whatsAppIndex = state.findIndex((s) => s.id === whatsAppId);\n    if (whatsAppIndex !== -1) {\n      state.splice(whatsAppIndex, 1);\n    }\n    return [...state];\n  }\n\n  if (action.type === \"RESET\") {\n    return [];\n  }\n};\n\nconst useWhatsApps = () => {\n  const [whatsApps, dispatch] = useReducer(reducer, []);\n  const [loading, setLoading] = useState(true);\n//   const socketManager = useContext(SocketContext);\n  const { user, socket } = useContext(AuthContext);\n\n\n\n  useEffect(() => {\n    setLoading(true);\n    const fetchSession = async () => {\n      try {\n        const { data } = await api.get(\"/whatsapp/?session=0\");\n        dispatch({ type: \"LOAD_WHATSAPPS\", payload: data });\n        setLoading(false);\n      } catch (_) {\n        setLoading(false);\n        // toastError(err);\n      }\n    };\n    fetchSession();\n  }, []);\n\n  useEffect(() => {\n    if (user.companyId) {\n\n      const companyId = user.companyId;\n//    const socket = socketManager.GetSocket();\n\n      const onCompanyWhatsapp = (data) => {\n        if (data.action === \"update\") {\n          dispatch({ type: \"UPDATE_WHATSAPPS\", payload: data.whatsapp });\n        }\n        if (data.action === \"delete\") {\n          dispatch({ type: \"DELETE_WHATSAPPS\", payload: data.whatsappId });\n        }\n      }\n\n      const onCompanyWhatsappSession = (data) => {\n        if (data.action === \"update\") {\n          dispatch({ type: \"UPDATE_SESSION\", payload: data.session });\n        }\n      }\n\n      socket.on(`company-${companyId}-whatsapp`, onCompanyWhatsapp);\n      socket.on(`company-${companyId}-whatsappSession`, onCompanyWhatsappSession);\n\n      return () => {\n        socket.off(`company-${companyId}-whatsapp`, onCompanyWhatsapp);\n        socket.off(`company-${companyId}-whatsappSession`, onCompanyWhatsappSession);\n      };\n    }\n  }, [socket]);\n\n  return { whatsApps, loading };\n};\n\nexport default useWhatsApps;\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module"}