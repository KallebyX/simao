#!/bin/bash

# ðŸ•’ Setup de Cron Jobs - SimÃ£o IA Rural
# ConfiguraÃ§Ã£o automÃ¡tica de backups e manutenÃ§Ã£o

set -e

echo "ðŸ•’ Configurando cron jobs para SimÃ£o IA Rural..."

# DiretÃ³rio do projeto
PROJECT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)
SCRIPTS_DIR="$PROJECT_DIR/scripts"

# Verificar se os scripts existem
if [[ ! -f "$SCRIPTS_DIR/backup_system.py" ]]; then
    echo "âŒ Script de backup nÃ£o encontrado: $SCRIPTS_DIR/backup_system.py"
    exit 1
fi

# Criar diretÃ³rio de logs se nÃ£o existir
LOG_DIR="/var/log/simao-ia-rural"
sudo mkdir -p "$LOG_DIR"
sudo chown -R $(whoami):$(whoami) "$LOG_DIR"

# Backup dos cron jobs existentes
echo "ðŸ’¾ Fazendo backup dos cron jobs atuais..."
crontab -l > "$PROJECT_DIR/cron_backup_$(date +%Y%m%d_%H%M%S).txt" 2>/dev/null || echo "# No existing crontab" > "$PROJECT_DIR/cron_backup_$(date +%Y%m%d_%H%M%S).txt"

# Criar arquivo temporÃ¡rio para novos cron jobs
TEMP_CRON=$(mktemp)

# Preservar cron jobs existentes (exceto os do SimÃ£o)
crontab -l 2>/dev/null | grep -v "# SimÃ£o IA Rural" | grep -v "backup_system.py" | grep -v "simao-" > "$TEMP_CRON" || true

cat >> "$TEMP_CRON" << 'EOF'

# ðŸŸ SimÃ£o IA Rural - Automated Jobs
# Generated by setup_cron.sh - Do not edit manually

# ðŸ”„ Backup diÃ¡rio completo Ã s 2h da manhÃ£
0 2 * * * cd /PROJECT_DIR && /usr/bin/python3 scripts/backup_system.py >> /var/log/simao-ia-rural/backup.log 2>&1 # SimÃ£o IA Rural

# ðŸ”„ Backup incremental a cada 6 horas (6h, 12h, 18h)
0 6,12,18 * * * cd /PROJECT_DIR && /usr/bin/python3 scripts/backup_system.py --incremental >> /var/log/simao-ia-rural/backup-incremental.log 2>&1 # SimÃ£o IA Rural

# ðŸ§¹ Limpeza de logs antigos (manter 30 dias)
0 3 * * * find /var/log/simao-ia-rural/ -name "*.log" -type f -mtime +30 -delete # SimÃ£o IA Rural

# ðŸ—„ï¸ OtimizaÃ§Ã£o do banco de dados - toda segunda Ã s 3h
0 3 * * 1 cd /PROJECT_DIR && /usr/bin/python3 scripts/db_maintenance.py --vacuum >> /var/log/simao-ia-rural/db-maintenance.log 2>&1 # SimÃ£o IA Rural

# ðŸ”´ Limpeza do Redis - todo domingo Ã s 4h
0 4 * * 0 cd /PROJECT_DIR && /usr/bin/python3 scripts/redis_maintenance.py --cleanup >> /var/log/simao-ia-rural/redis-maintenance.log 2>&1 # SimÃ£o IA Rural

# ðŸ“Š RelatÃ³rio semanal de custos - todo domingo Ã s 8h
0 8 * * 0 cd /PROJECT_DIR && /usr/bin/python3 scripts/generate_reports.py --weekly >> /var/log/simao-ia-rural/reports.log 2>&1 # SimÃ£o IA Rural

# ðŸ’° Monitoramento de custos Gemini - a cada hora (horÃ¡rio comercial)
0 8-18 * * 1-5 cd /PROJECT_DIR && /usr/bin/python3 scripts/cost_monitor.py >> /var/log/simao-ia-rural/cost-monitor.log 2>&1 # SimÃ£o IA Rural

# ðŸ¥ Health check do sistema - a cada 15 minutos
*/15 * * * * cd /PROJECT_DIR && /usr/bin/python3 scripts/health_check.py >> /var/log/simao-ia-rural/health-check.log 2>&1 # SimÃ£o IA Rural

# ðŸ”” VerificaÃ§Ã£o de alertas pendentes - a cada 5 minutos
*/5 * * * * cd /PROJECT_DIR && /usr/bin/python3 scripts/alert_processor.py >> /var/log/simao-ia-rural/alerts.log 2>&1 # SimÃ£o IA Rural

# ðŸ“ˆ Update de mÃ©tricas de performance - a cada hora
0 * * * * cd /PROJECT_DIR && /usr/bin/python3 scripts/update_metrics.py >> /var/log/simao-ia-rural/metrics.log 2>&1 # SimÃ£o IA Rural

EOF

# Substituir placeholder pelo diretÃ³rio real
sed -i "s|/PROJECT_DIR|$PROJECT_DIR|g" "$TEMP_CRON"

# Instalar novos cron jobs
crontab "$TEMP_CRON"

# Limpar arquivo temporÃ¡rio
rm "$TEMP_CRON"

echo "âœ… Cron jobs configurados com sucesso!"

# Mostrar cron jobs instalados
echo "
ðŸ“‹ Cron jobs do SimÃ£o IA Rural instalados:
================================================"
crontab -l | grep "SimÃ£o IA Rural" -A 1

echo "
ðŸ“Š Resumo dos agendamentos:
================================================
ðŸ”„ Backup completo:      DiÃ¡rio Ã s 2h
ðŸ”„ Backup incremental:   A cada 6h (6h, 12h, 18h)  
ðŸ§¹ Limpeza logs:         DiÃ¡rio Ã s 3h
ðŸ—„ï¸ ManutenÃ§Ã£o DB:        Segunda Ã s 3h
ðŸ”´ ManutenÃ§Ã£o Redis:     Domingo Ã s 4h
ðŸ“Š RelatÃ³rio semanal:    Domingo Ã s 8h
ðŸ’° Monitor custos:       Hora em hora (8h-18h, seg-sex)
ðŸ¥ Health check:         A cada 15 minutos
ðŸ”” Verificar alertas:    A cada 5 minutos
ðŸ“ˆ Update mÃ©tricas:      A cada hora
================================================

ðŸ“ Logs em: /var/log/simao-ia-rural/
ðŸ’¾ Backup cron anterior: $PROJECT_DIR/cron_backup_*.txt

âš ï¸  IMPORTANTE:
- Verifique se as variÃ¡veis de ambiente estÃ£o configuradas
- Confirme permissÃµes de escrita em /var/log/simao-ia-rural/
- Teste os scripts manualmente antes de confiar nos cron jobs
"

# Verificar se serviÃ§o cron estÃ¡ rodando
if systemctl is-active --quiet cron; then
    echo "âœ… ServiÃ§o cron estÃ¡ ativo"
elif systemctl is-active --quiet crond; then
    echo "âœ… ServiÃ§o crond estÃ¡ ativo"  
else
    echo "âš ï¸  AVISO: ServiÃ§o cron nÃ£o estÃ¡ rodando!"
    echo "   Para Ubuntu/Debian: sudo systemctl start cron"
    echo "   Para CentOS/RHEL: sudo systemctl start crond"
fi

# Criar script de verificaÃ§Ã£o de cron jobs
cat > "$SCRIPTS_DIR/verify_cron.sh" << 'EOF'
#!/bin/bash
# ðŸ” Verificador de Cron Jobs - SimÃ£o IA Rural

echo "ðŸ” Verificando status dos cron jobs..."

LOG_DIR="/var/log/simao-ia-rural"

if [[ ! -d "$LOG_DIR" ]]; then
    echo "âŒ DiretÃ³rio de logs nÃ£o existe: $LOG_DIR"
    exit 1
fi

echo "ðŸ“Š Status dos logs (Ãºltimas 24h):"
echo "=================================="

for log_file in "$LOG_DIR"/*.log; do
    if [[ -f "$log_file" ]]; then
        filename=$(basename "$log_file")
        size=$(du -sh "$log_file" | cut -f1)
        last_modified=$(stat -c %y "$log_file" | cut -d' ' -f1,2 | cut -d'.' -f1)
        
        # Verificar se foi modificado nas Ãºltimas 24h
        if [[ $(find "$log_file" -mtime -1) ]]; then
            status="âœ… Ativo"
        else
            status="âš ï¸  Inativo"
        fi
        
        echo "$status $filename - $size - $last_modified"
    fi
done

echo ""
echo "ðŸ“‹ Cron jobs instalados:"
echo "========================"
crontab -l | grep "SimÃ£o IA Rural" | wc -l | xargs echo "Total:"

echo ""
echo "ðŸ”„ Para ver logs em tempo real:"
echo "tail -f $LOG_DIR/backup.log"
echo "tail -f $LOG_DIR/health-check.log"
EOF

chmod +x "$SCRIPTS_DIR/verify_cron.sh"

echo "
ðŸ”§ Script de verificaÃ§Ã£o criado: $SCRIPTS_DIR/verify_cron.sh
   Execute para verificar status dos cron jobs
"